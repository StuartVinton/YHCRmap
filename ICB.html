<!DOCTYPE html>
<html>
<head>
    <title>Integrated Care Boards Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>

    <style>
        #map {
            height: 600px;
        }
        h1 {
            font-family: Calibri, sans-serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            right: 1%;
            top: 15%;
            background-color: white;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            width: 550px;
            max-height: 100%;
            overflow-y: auto;
        }
        .modal-header {
            font-size: 20px;
            margin-bottom: 10px;
            font-family: Calibri, sans-serif;
        }
        .modal-table {
            width: 100%;
            border-collapse: collapse;
            font-family: Calibri, sans-serif;
        }
        .modal-table th, .modal-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .modal-table th {
            background-color: #f4f4f4;
        }
        .close {
            cursor: pointer;
            float: right;
            font-size: 20px;
            margin-top: -10px;
        }
    </style>
</head>
<body>
    <h1>Interweave Data Providers by Integrated Care Boards</h1>
    <div id="map"></div>

    <!-- Modal for Table -->
    <div id="modal" class="modal">
        <span class="close" onclick="closeModal()">Ã—</span>
        <div id="modal-header" class="modal-header"></div>
        <table id="modal-table" class="modal-table"></table>
    </div>

    <script>
        // Initialize map
        const map = L.map('map').setView([53.5, -0.6], 8);

        // Add base map layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // JSON data for NHS organisations
        const nhsData = [
    {
        "name": "Airedale NHS Foundation Trust",
        "region": "WY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "PractitionerRole",
            "Organization",
            "DocumentReference"
        ]
    },
    {
        "name": "Barnsley Hospital NHS Foundation Trust",
        "region": "SY",
        "resourcesProvided": [
            "Encounter",
            "Patient",
            "Appointment",
            "Organization",
            "Practitioner",
            "Location"
        ]
    },
    {
        "name": "Bradford Teaching Hospitals Foundation Trust",
        "region": "WY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "PractitionerRole",
            "Organization",
            "DocumentReference",
            "Encounter",
            "DiagnosticReport"
        ]
    },
    {
        "name": "Calderdale and Huddersfield NHS Foundation Trust",
        "region": "WY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "PractitionerRole",
            "Organization",
            "DocumentReference",
            "Encounter",
            "Location"
        ]
    },
    {
        "name": "Doncaster & Bassetlaw Teaching Hospitals Foundation Trust",
        "region": "SY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "Organization",
            "DocumentReference",
            "Encounter",
            "AllergyIntolerance",
            "Appointment",
            "Flag",
            "MedicationRequest",
            "Procedure",
            "Condition",
            "ReferralRequest"
        ]
    },
    {
        "name": "Harrogate and District NHS Foundation Trust",
        "region": "HNY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "Organization",
            "Encounter",
            "Appointment",
            "Location"
        ]
    },
    {
        "name": "Hull University Teaching Hospitals NHS Trust",
        "region": "HNY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "PractitionerRole",
            "Organization",
            "Encounter",
            "EpisodeOfCare",
            "Appointment",
            "Location"
        ]
    },
    {
        "name": "Humber Teaching NHS Foundation Trust",
        "region": "HNY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "PractitionerRole",
            "Organization",
            "DocumentReference",
            "Encounter",
            "Observation",
            "AllergyIntolerance",
            "Procedure",
            "Condition"
        ]
    },
    {
        "name": "Leeds Teaching Hospital Trust",
        "region": "WY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "PractitionerRole",
            "Organization",
            "DocumentReference"
        ]
    },
    {
        "name": "Mid Yorkshire Teaching NHS Trust",
        "region": "WY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "PractitionerRole",
            "Organization",
            "DocumentReference",
            "Encounter",
            "Appointment"
        ]
    },
    {
        "name": "North Lincolnshire Council",
        "region": "HNY",
        "resourcesProvided": [
            "Patient"
        ]
    },
    {
        "name": "North Lincolnshire and Goole NHS Foundation Trust",
        "region": "HNY",
        "resourcesProvided": [
            "Patient",
            "DocumentReference",
            "Encounter"
        ]
    },
    {
        "name": "North Yorkshire Council",
        "region": "HNY",
        "resourcesProvided": [
            "Patient",
            "Practitioner",
            "EpisodeOfCare",
            "RelatedPerson",
            "Task",
            "ReferralRequest"
        ]
    },
    {
        "name": "Sheffield Children's NHS Foundation Trust",
        "region": "SY",
        "resourcesProvided": [
            "Organization",
            "Location",
            "Patient",
            "Appointment",
            "Encounter",
            "DocumentReference",
            "Flag",
            "AllergyIntolerance",
            "ReferralRequest",
            "Practitioner"
        ]
    },
    {
        "name": "Sheffield Teaching Hospitals NHS Foundation Trust",
        "region": "SY",
        "resourcesProvided": [
            "Appointment",
            "Encounter",
            "Organization",
            "Patient",
            "Location"
        ]
    },
    {
        "name": "The Rotherham NHS Foundation Trust",
        "region": "SY",
        "resourcesProvided": [
            "Encounter",
            "Organization",
            "Practitioner",
            "Patient",
            "Location",
            "AllergyIntolerance",
            "DocumentReference",
            "Binary"
        ]
    },
    {
        "name": "York and Scarborough Teaching Hospital NHS Foundation Trust",
        "region": "HNY",
        "resourcesProvided": [
            "Patient",
            "Organization",
            "DocumentReference"
        ]
    }
];

        // Map from ICB name to region code
        const regionMapping = {
            "NHS Humber and North Yorkshire Integrated Care Board": "HNY",
            "NHS South Yorkshire Integrated Care Board": "SY",
            "NHS West Yorkshire Integrated Care Board": "WY",
            "NHS Lincolnshire Integrated Care Board": "LIN",
            "NHS Derby and Derbyshire Integrated Care Board": "DER",
            "NHS Leicester, Leicestershire and Rutland Integrated Care Board": "LLR",
			"NHS Nottingham and Nottinghamshire Integrated Care Board": "NCR"
        };

        // Function to display modal with table
function showModal(regionCode, regionName) {
    const modal = document.getElementById("modal");
    const modalHeader = document.getElementById("modal-header");
    const modalTable = document.getElementById("modal-table");

    // Set header
    modalHeader.textContent = `${regionName}`;

    // Build table
    modalTable.innerHTML = `
        <tr>
            <th>Provider</th>
            <th>Resources Available</th>
        </tr>
    `;

    nhsData
        .filter(org => org.region === regionCode)
        .forEach(org => {
            modalTable.innerHTML += `
                <tr>
                    <td>
                        <a href="#" onclick="addProviderMarker('${org.name}')">${org.name}</a>
                    </td>
                    <td>${org.resourcesProvided.join(", ")}</td>
                </tr>
            `;
        });

    // Show modal
    modal.style.display = "block";
}

// Track the current marker to remove it later
let currentMarker = null;

const markers = [
    { id: "RCB", coords: [54.000, -1.000], name: "York and Scarborough Teaching Hospital NHS Foundation Trust", color: "darkblue" },
    { id: "RX9", coords: [53.000, -0.500], name: "East Midlands Ambulance Service", color: "darkblue" },
    { id: "RCU", coords: [53.400, -1.500], name: "Sheffield Children's NHS Foundation Trust", color: "darkblue" },
    { id: "RFF", coords: [53.550, -1.500], name: "Barnsley Hospital NHS Foundation Trust", color: "darkblue" },
    { id: "RWY", coords: [53.650, -1.800], name: "Calderdale and Huddersfield NHS Foundation Trust", color: "darkblue" },
    { id: "RHQ", coords: [53.380, -1.470], name: "Sheffield Teaching Hospitals NHS Foundation Trust", color: "darkblue" },
    { id: "217", coords: [53.550, -0.650], name: "North Lincolnshire Council", color: "darkblue" },
    { id: "215", coords: [53.750, -0.350], name: "Hull City Council", color: "darkblue" },
    { id: "RX3", coords: [54.500, -1.200], name: "Tees, Esk and Wear Valleys NHS Foundation Trust", color: "darkblue" },
    { id: "RR8", coords: [53.800, -1.560], name: "Leeds Teaching Hospital Trust", color: "darkblue" },
    { id: "RV9", coords: [53.7712215,-0.4466298], name: "Humber Teaching NHS Foundation Trust", color: "darkblue" },
    { id: "RCF", coords: [53.900, -1.750], name: "Airedale NHS Foundation Trust", color: "darkblue" },
    { id: "RAE01", coords: [53.800, -1.790], name: "Bradford Teaching Hospitals Foundation Trust", color: "darkblue" },
    { id: "RP5", coords: [53.520, -1.130], name: "Doncaster & Bassetlaw Teaching Hospitals Foundation Trust", color: "darkblue" },
    { id: "RFX8TOC", coords: [53.500, -1.400], name: "Yorkshire Ambulance Service", color: "darkblue" },
    { id: "RFR", coords: [53.380, -1.410], name: "The Rotherham NHS Foundation Trust", color: "darkblue" },
    { id: "RXF", coords: [53.690, -1.690], name: "Mid Yorkshire Teaching NHS Trust", color: "darkblue" },
    { id: "RJL1", coords: [53.587034,-0.667200], name: "North Lincolnshire and Goole NHS Foundation Trust", color: "darkblue" },
    { id: "RWA", coords: [53.744191,-0.3588982], name: "Hull University Teaching Hospitals NHS Trust", color: "darkblue" },
    { id: "RCD", coords: [53.9937493,-1.517829], name: "Harrogate and District NHS Foundation Trust", color: "darkblue" },
	{ id: "T999", coords: [54.281,-1.624], name: "North Yorkshire Council", color: "darkblue" }
	
	
];



function addProviderMarker(providerName) {
    // Find the provider in the markers list
    const provider = markers.find(marker => marker.name === providerName);

    if (!provider) {
        alert("Provider location not found!");
        return;
    }

    // Remove existing marker if any
    if (currentMarker) {
        map.removeLayer(currentMarker);
    }

    // Create a new marker for the provider
    currentMarker = L.marker(provider.coords, {
        icon: L.AwesomeMarkers.icon({
            icon: 'info-sign',
            iconColor: 'white',
            markerColor: provider.color,
            prefix: 'glyphicon'
        }),
        title: provider.name
    });

    // Bind a tooltip
    currentMarker.bindTooltip(provider.name, {
        permanent: true,
        direction: "right"
    });

    // Add the marker to the correct map
    currentMarker.addTo(map);

    // Pan the map to the new marker
   map.setView([53.5, -0.6], 8);
}



        // Function to close modal
function closeModal() {
    const modal = document.getElementById("modal");
    modal.style.display = "none"; // Hide the modal

    // Reset the map view
    map.setView([53.5, -0.6], 8);

    // Reset the last selected ICB to blue
    if (lastSelectedICB) {
        lastSelectedICB.setStyle({ color: "blue" });
        lastSelectedICB = null;
    }

    // Remove any existing markers from the map
    if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
    }
}


        // Fetch GeoJSON data from ArcGIS REST Service
        const geojsonUrl = "https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BFC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson";

       // Store reference to the last selected ICB
let lastSelectedICB = null;

fetch(geojsonUrl)
    .then(response => response.json())
    .then(data => {
        L.geoJSON(data, {
            filter: feature => Object.keys(regionMapping).includes(feature.properties.ICB23NM),
            style: { color: "blue", weight: 2 },
            onEachFeature: (feature, layer) => {
                const icbName = feature.properties.ICB23NM;
                const regionCode = regionMapping[icbName]; 
                const regionName = icbName;

                // Add hover tooltip for all regions
                layer.bindTooltip(regionName, { permanent: false, direction: "top" });

                // Change color to green on hover
                layer.on("mouseover", () => {
                    layer.setStyle({ color: "green" });
                });

                // Reset to original color on mouseout (only if not selected)
                layer.on("mouseout", () => {
                    if (lastSelectedICB !== layer) {
                        layer.setStyle({ color: "blue" });
                    }
                });

                // Click event to highlight selected ICB
                layer.on("click", () => {
                    // Reset previous selected ICB to blue
                    if (lastSelectedICB) {
                        lastSelectedICB.setStyle({ color: "blue" });
                    }

                    // Highlight clicked ICB in red
                    layer.setStyle({ color: "green" });
                    lastSelectedICB = layer; // Store the clicked ICB

                    // Open the modal
                    if (regionCode) {
                        showModal(regionCode, regionName);
                    }
                });
            }
        }).addTo(map);
    })
    .catch(error => console.error("Error loading GeoJSON:", error));

    </script>
</body>
</html>
