<!DOCTYPE html>
<html>
<head>
    <title>Integrated Care Boards Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map {
            height: 600px;
        }
        h1 {
            font-family: Calibri, sans-serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            right: 0;
            top: 20%;
            background-color: white;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 550px;
            max-height: 70%;
            overflow-y: auto;
        }
        .modal-header {
            font-size: 20px;
            margin-bottom: 10px;
            font-family: Calibri, sans-serif;
        }
        .modal-table {
            width: 100%;
            border-collapse: collapse;
            font-family: Calibri, sans-serif;
        }
        .modal-table th, .modal-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .modal-table th {
            background-color: #f4f4f4;
        }
        .close {
            cursor: pointer;
            float: right;
            font-size: 20px;
            margin-top: -10px;
        }
    </style>
</head>
<body>
    <h1>Integrated Care Systems in England</h1>
    <div id="map"></div>

    <!-- Modal for Table -->
    <div id="modal" class="modal">
        <span class="close" onclick="closeModal()">Ã—</span>
        <div id="modal-header" class="modal-header"></div>
        <table id="modal-table" class="modal-table"></table>
    </div>

    <script>
        // Initialize map
        const map = L.map('map').setView([53.8, -1.5], 6);

        // Add base map layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // JSON data for NHS organisations
        const nhsData = [
            {
                "name": "Humber Teaching NHS Foundation Trust",
                "region": "HNY",
                "resourcesProvided": [
                    "Organisation",
                    "Patient",
                    "Practitioner",
                    "Practitioner Role",
                    "Appointments",
                    "Care Plans",
                    "Condition",
                    "Diagnostic Report",
                    "Medication Request",
                    "Transfer of Care"
                ]
            },
            {
                "name": "Barnsley Hospital NHS Foundation Trust",
                "region": "SY",
                "resourcesProvided": [
                    "Allergies/Intolerance",
                    "Care Plans",
                    "Condition",
                    "Diagnostic Report",
                    "Medication Request"
                ]
            },
            {
                "name": "Bradford Teaching Hospitals NHS Foundation Trust",
                "region": "WY",
                "resourcesProvided": [
                    "Appointments",
                    "Discharge Summaries",
                    "Encounters",
                    "Location",
                    "Episodes of Care"
                ]
            }
        ];

        // Map from ICB name to region code
        const regionMapping = {
            "NHS Humber and North Yorkshire Integrated Care Board": "HNY",
            "NHS South Yorkshire Integrated Care Board": "SY",
            "NHS West Yorkshire Integrated Care Board": "WY",
            "NHS Lincolnshire Integrated Care Board": "LIN",
            "NHS Derby and Derbyshire Integrated Care Board": "DER",
            "NHS Leicester, Leicestershire and Rutland Integrated Care Board": "LLR",
			"NHS Nottingham and Nottinghamshire Integrated Care Board": "NCR"
        };

        // Function to display modal with table
        function showModal(regionCode, regionName) {
            const modal = document.getElementById("modal");
            const modalHeader = document.getElementById("modal-header");
            const modalTable = document.getElementById("modal-table");

            // Set header
            modalHeader.textContent = `Data for ${regionName}`;

            // Build table
            modalTable.innerHTML = `
                <tr>
                    <th>Provider</th>
                    <th>Resources Available</th>
                </tr>
            `;

            nhsData
                .filter(org => org.region === regionCode)
                .forEach(org => {
                    modalTable.innerHTML += `
                        <tr>
                            <td>${org.name}</td>
                            <td>${org.resourcesProvided.join(", ")}</td>
                        </tr>
                    `;
                });

            // Show modal
            modal.style.display = "block";
        }

        // Function to close modal
        function closeModal() {
            document.getElementById("modal").style.display = "none";
        }

        // Fetch GeoJSON data from ArcGIS REST Service
        const geojsonUrl = "https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Integrated_Care_Boards_April_2023_EN_BFC/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson";

        fetch(geojsonUrl)
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    filter: feature => Object.keys(regionMapping).includes(feature.properties.ICB23NM),
                    style: { color: "blue", weight: 2 },
                    onEachFeature: (feature, layer) => {
                        const icbName = feature.properties.ICB23NM;
                        const regionCode = regionMapping[icbName]; 
                        const regionName = icbName;

                        // Add hover tooltip for all regions
                        layer.bindTooltip(regionName, { permanent: false, direction: "top" });

                        // Change color to green on hover
                        layer.on("mouseover", () => {
                            layer.setStyle({ color: "green" });
                        });

                        // Reset to original color on mouseout
                        layer.on("mouseout", () => {
                            layer.setStyle({ color: "blue" });
                        });

                        // Open modal only for regions in NHS data
                        layer.on("click", () => {
                            if (regionCode) {
                                showModal(regionCode, regionName);
                            }
                        });
                    }
                }).addTo(map);
            })
            .catch(error => console.error("Error loading GeoJSON:", error));
    </script>
</body>
</html>
